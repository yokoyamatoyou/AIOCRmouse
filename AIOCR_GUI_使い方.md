# AIOCR GUI 使い方ガイド

本ガイドは、AIOCRアプリの各画面（テンプレート作成、メインOCR、レビュー＆修正、ダッシュボード、管理設定）の使い方を項目別に解説します。運用者（作業者）と管理者の役割分担を前提に、UXを最適化しています。

## 0. 起動方法（概要）
- 推奨: `setup_and_run.bat` をダブルクリック
- 手動起動: 仮想環境を有効化後に次を実行
  - `streamlit run src/app/main.py`
- ブラウザが開かない場合: コンソールに表示される URL をコピーしてブラウザで開いてください

## 1. 画面構成（サイドバー）
- `Template Editor`: 帳票テンプレートの作成・編集（ROIやルール設定）
- `Main OCR`: 画像読み取り（バッチ処理／自動テンプレート検出対応）
- `Review & 修正`: ヒューマンインザループで結果確認と修正、辞書登録
- `ダッシュボード`: 件数や自動確定率を可視化
- `管理設定`: スコア重み・閾値、メンテナンス（管理者用）

---

## 2. Template Editor（テンプレート作成/編集）
1) 画像アップロード
- 「基準画像をアップロード」に帳票の代表画像を登録

2) ROI（読み取り領域）の描画
- マウスで矩形（四角形）をドラッグして領域を指定
- 追加/移動/削除で領域を調整

3) ROI設定項目
- 名称: フィールド名（重複は自動で解消）
- フィールドタイプ: `fixed`（数値/日付など厳格検証） or `qualitative`（備考など定性）
- ルールタイプ: 空/正規表現（regex）/範囲（range:min,max）/選択肢（enum）
- ルールパラメータ: タイプに応じて入力
- 信頼度閾値: 0.0〜1.0（エンジン自信度の下限）

4) 品質ゲート（画像品質チェック）
- 有効化（既定ON）/閾値（Laplacian分散; 数値が大きいほど厳格）
- 低品質な画像はOCR処理をスキップし、DBに `QualityCheckFailed` として記録

5) 保存
- テンプレート名を入力し「保存」
- JSONは `templates/` に保存、アップロード画像はテンプレート名で保存

---

## 3. Main OCR（画像読み取り）
1) 入力形式
- 「画像ファイル」複数アップロード
- 「ZIP/フォルダ」指定（中の画像を一括展開・読み込み）

2) OCRエンジン選択
- 既定: 一次OCR = `GPT-5-nano-2025-08-07`、二次バリデータ = `GPT-5-mini-2025-08-07`
- 将来のモデル追加は自動的に選択肢へ反映（動的リスト）

3) テンプレート選択
- 自動検出: すべての画像からキーワード検知でテンプレートを自動選択
- 手動選択: プルダウンでテンプレートを固定

4) 実行
- 「OCR処理実行」ボタンで開始
- 進捗バー／検出ログ表示

5) 出力表示
- 作業ディレクトリ一覧: `workspace/DOC_*/` のパスを表示
- 抽出結果: `extract.json` 相当の内容を画面に表示
- 信頼度とダブルチェック結果: 各フィールドの `confidence` とレベル（low/medium/high）

6) 品質ゲートの集計
- 解析対象画像数 / 低品質で除外 / 実際に解析 の件数を表示
- 低品質と判定されたファイルの一覧も表示

---

## 4. Review & 修正（ヒューマンインザループ）
- `needs_human=True` の項目が一覧表示されます
- 操作
  - 切り出し画像（ROI）を確認
  - `AI結果`を基にテキストを修正
  - 「辞書に登録」をONにすると誤→正の対を `corrections.jsonl` とテンプレート辞書へ登録
  - 「修正を保存」で `extract.json` と DB を更新（`status=confirmed`、`corrected_by_user=1`）

---

## 5. ダッシュボード（指標可視化）
- 指標
  - 総処理ドキュメント数 / 総処理フィールド数
  - 自動確定率（`needs_human` の有無で算出）
- グラフ
  - 日別処理数（折れ線）
  - テンプレート別処理数（棒）

---

## 6. 管理設定（管理者用）
1) スコア重み・閾値（セッション適用）
- スライダーで調整
  - OCR自信度の重み
  - ルール適合の重み
  - モデル一致度の重み
  - 複合スコアの確定閾値（既定 0.8）
- 「変更を適用」でセッション内に反映（即時効果）
- 恒久変更: `.env` に以下を設定
  - `SCORE_WEIGHT_OCR=0.5`
  - `SCORE_WEIGHT_RULE=0.3`
  - `SCORE_WEIGHT_AGREEMENT=0.2`
  - `COMPOSITE_DECISION_THRESHOLD=0.8`

2) DBメンテナンス
- DBパスの表示、接続再初期化（次操作で再接続）

---

## 7. モデルとAPIの注意
- 既定モデル
  - 一次: `GPT-5-nano-2025-08-07`
  - 二次: `GPT-5-mini-2025-08-07`
- API: Chat Completions `/v1/chat/completions`（ステートレス）
- OPENAI_API_KEY を `.env` または環境変数で設定

---

## 8. 作業ディレクトリ構成（例）
```
workspace/
  DOC_YYYYMMDD_hhmmss_UUID/
    crops/                # ROI切り出し画像
    extract.json          # 抽出結果（IDやスコア含む）
    template.json         # 処理に使用したテンプレートの写し
corrections.jsonl         # レビューで蓄積する誤→正の辞書（全体）
```

---

## 9. トラブルシュート
- APIキー未設定: `OPENAI_API_KEY` を設定してください
- 低品質が多い: 管理設定またはテンプレートの品質ゲート閾値を下げる
- テンプレート未検出: 自動検出後の手動選択でテンプレートを指定
- 既存DBに新カラムがない: アプリ起動時に自動で `ALTER TABLE` します

---

## 10. よくある質問（FAQ）
- 重みをテンプレート/ROIごとに変えたい
  - 仕様追加で対応可能です。要件をご連絡ください
- 旧モデル（GPT-4.1系）も使える？
  - 利用可能です。サイドバーのエンジン選択から変更してください

