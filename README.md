# AIOCR: AIによる高精度OCRアプリケーション

このプロジェクトは、手書き帳票などの画像からテキストを抽出し、データ入力を自動化・支援するためのAI-OCRツールです。Streamlitを使用して構築されており、直感的なUIで操作できます。

## 1. 発生していた問題と解決策

### 問題の原因

以前のバージョンでは、`Template Editor`ページでROI（読み取り範囲）を指定する際にエラーが発生していました。これは、プロジェクトが使用している`streamlit`と、描画ライブラリである`streamlit-drawable-canvas`の間にバージョンの互換性がなかったことが原因です。

また、`Poetry`というツールで依存関係を管理していましたが、環境構築が複雑になりがちで、ユーザーの環境で意図せず古いバージョンのライブラリが使われてしまう問題がありました。

### 解決策

この問題を根本的に解決し、誰でも簡単に安定した環境を構築できるように、以下の改善を行いました。

1.  **Python標準の仮想環境(`venv`)を利用:** プロジェクトごとに独立したPython環境を用意することで、他のプログラムとの依存関係の衝突を防ぎます。
2.  **`pip`と`requirements.txt`によるシンプルなパッケージ管理:** 必要なライブラリとそのバージョンを`requirements.txt`に明記し、`pip`コマンドで一括インストールできるようにしました。
3.  **セットアップと実行の完全自動化:** `setup_and_run.bat`というバッチファイルをダブルクリックするだけで、仮想環境の構築からライブラリのインストール、アプリケーションの起動までが自動的に行われるようにしました。

---

## 2. 簡単実行ガイド（推奨）

Windowsユーザーは付属の `setup_and_run.bat` をダブルクリックするだけで、仮想環境の作成から依存関係のインストール、`PYTHONPATH` への `src` 追加、`streamlit run src/app/main.py` の実行まで自動で行われます。

専門的な知識は不要です。以下の手順でアプリケーションを起動できます。

1.  プロジェクトファイルをダウンロードして、任意の場所に展開します。
2.  `setup_and_run.bat` ファイルを探し、ダブルクリックして実行します。
3.  初回実行時は、コマンドプロンプトの画面が開き、仮想環境の構築と必要なライブラリのインストールが自動的に始まります。（少し時間がかかります）
4.  セットアップが完了すると、自動的にブラウザが立ち上がり、AIOCRアプリケーションが表示されます。

次回以降は、`setup_and_run.bat` を実行すればすぐにアプリケーションが起動します。

---

## 3. 手動での環境構築ガイド

開発やカスタマイズを行いたい方向けに、手動でのセットアップ手順を記載します。

### ステップ 1: 仮想環境の作成と有効化

まず、プロジェクトのルートディレクトリでコマンドプロンプトを開き、以下のコマンドを実行して`.venv`という名前の仮想環境を作成します。

```bash
python -m venv .venv
```

次に、作成した仮想環境を有効化（アクティベート）します。

```
.venv\Scripts\activate
```

コマンドプロンプトの行頭に (.venv) と表示されれば、仮想環境が有効になっています。

### ステップ 2: 依存ライブラリのインストール

以下のコマンドを実行し、requirements.txt に記載されたライブラリをインストールします。

```bash
pip install -r requirements.txt
```

### ステップ 3: アプリケーションの実行

以下のコマンドでStreamlitアプリケーションを起動します。

```bash
streamlit run src/app/main.py
```

### 3.1 PowerShellの実行ポリシーで起動できない場合
- `.venv\Scripts\Activate.ps1 はデジタル署名されていません` と表示される場合は、PowerShellを管理者で開き以下を実行:
```
Set-ExecutionPolicy -Scope CurrentUser RemoteSigned
```
その後、`setup_and_run.bat` を再実行してください。

### 3.2 モジュールインポートが失敗する場合
- 本リポジトリ直下の `sitecustomize.py` により `src` が自動で `sys.path` に追加されます。通常は `PYTHONPATH` 設定不要です。
  それでも `ModuleNotFoundError: core` が出る場合は、`streamlit run` をプロジェクトルートから実行してください。

## 5. Dockerでの起動（依存を隔離した仮想化）
```bash
docker build -t aiocr-app .
docker run --rm -p 8501:8501 -v %cd%/workspace:/app/workspace -v %cd%/templates:/app/templates aiocr-app
```
ブラウザで `http://localhost:8501` を開いてください。

## 4. 使い方

1. **テンプレートの作成:**
   * サイドバーから Template Editor を選択します。
   * 基準となる帳票の画像をアップロードします。
   * 画像の上でマウスをドラッグして、読み取りたい領域（ROI）を四角形で囲みます。
   * 各ROIに名前や検証ルール（例: regex:^\d{7}$ で郵便番号を検証）に加えて、フィールドタイプ（fixed/qualitative）を設定します。
   * 必要に応じて「品質ゲート」を有効化し、鮮明度の閾値を設定できます。低品質な画像は処理前に自動スキップされます。
   * テンプレート名を入力して「保存」します。
2. **OCRの実行:**
   * サイドバーから Main OCR を選択します。
   * 処理したい画像（複数可）をアップロードします。
   * 先ほど作成したテンプレートを選択します。
   * 「OCR処理実行」ボタンを押すと、処理が開始されます。OCRエンジンはサイドバーから選択でき、`GPT-5-mini` を含む最新のエンジンにも対応しています。
3. **結果のレビュー:**
   * サイドバーから Review を選択します。
   * AIが読み取りに自信がない、または検証ルールに違反した項目が一覧表示されます。
   * 画像を確認しながら、正しいテキストに修正し、結果を確定できます。

