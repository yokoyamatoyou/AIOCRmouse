# AI-OCR アプリケーション調査報告書

このドキュメントは、AI-OCRアプリケーションのコードベースを調査した結果見つかった問題点、バグ、および改善提案をまとめたものです。

## 概要

このアプリケーションは、Streamlitをベースに構築された高機能なOCRツールであり、テンプレート定義、複数エンジンによるOCR、手動レビュー機能などを備えています。コードは全体的によく構造化されていますが、いくつかの重大な問題と、ユーザー体験を向上させるための改善点が見つかりました。

---

## A. 重大度・高 (アプリケーションの動作に影響)

これらの問題はアプリケーションのインストールや正常な動作を妨げるため、優先的に対処する必要があります。

### A-1. 依存関係の競合によるインストール失敗

-   **現状の問題:**
    `requirements.txt` に記載されている依存関係に、致命的な競合が存在します。具体的には、`streamlit==1.31.0` が要求されていますが、`streamlit-drawable-canvas-fix==0.9.7` は `streamlit>=1.40.0` を必要とします。この矛盾により、`pip install -r requirements.txt` を実行するとエラーが発生し、環境を構築することができません。

-   **推奨される解決策:**
    1.  `streamlit-drawable-canvas-fix` のバージョンを、`streamlit==1.31.0` と互換性のある古いバージョンに下げる。
    2.  または、`streamlit` のバージョンを `1.40.0` 以上に上げ、他のライブラリとの互換性を再検証する。
    `README.md` には過去に互換性問題を解決したと記載があるため、その際のバージョンに戻すのが最も安全な可能性があります。

### A-2. 非同期処理のバグによる機能不全の可能性

-   **現状の問題:**
    `src/app/pages/1_Main_OCR.py` 内のテンプレート自動検出機能で `asyncio.run()` が使用されています。Streamlitは既に実行中のイベントループ上で動作しているため、このコードは `RuntimeError: asyncio.run() cannot be called from a running event loop` という実行時エラーを引き起こす可能性が非常に高いです。

-   **推奨される解決策:**
    `asyncio.run()` を使用する代わりに、`asyncio.get_event_loop()` を使って既存のイベントループを取得し、そのループで非同期タスクを実行するようにコードを修正してください。これにより、Streamlitのアーキテクチャ内で安全に非同期処理を実行できます。

---

## B. 中程度 (機能・保守性・セキュリティ)

これらの問題は、アプリケーションの保守性やセキュリティに影響を与える可能性があります。

### B-1. ハードコードされた設定値

-   **現状の問題:**
    `src/app/pages/1_Main_OCR.py` 内で、一次OCRエンジンや検証用エンジンのモデル名 (`"GPT-5-nano-2025-08-07"` など) がハードコードされています。将来的にモデル名が変更された場合、コードを直接編集しないと対応できません。

-   **推奨される解決策:**
    これらの設定値を `core/config.py` や外部の設定ファイル（例: `config.yaml`）に移動させることを推奨します。これにより、コードのロジックに触れることなく、管理者が安全かつ容易に設定を変更できるようになります。

### B-2. ローカルフォルダパス機能のセキュリティリスク

-   **現状の問題:**
    OCR実行ページで、サーバーのローカルファイルシステムのフォルダパスを直接入力できます。この機能はローカルでの利用には便利ですが、もしアプリケーションがWebサーバー上で複数ユーザーに公開される場合、悪意のあるユーザーが意図しないパス（例: `/etc/passwd`, `C:\Users`）を指定することで、セキュリティ上の問題を引き起こす可能性があります。

-   **推奨される解決策:**
    -   この機能がローカルでの利用のみを想定していることをドキュメントに明記する。
    -   Web上でデプロイする場合は、この機能を無効化するか、アクセス可能なベースディレクトリを限定するなどの制限を設けることを強く推奨します。

---

## C. 軽微 (UI/UXの改善提案)

これらは機能的なバグではありませんが、ユーザー体験（UX）を大きく向上させるための提案です。

### C-1. テンプレートエディタのUI改善

-   **現状の問題:**
    `Template Editor` ページでは、定義したROI（読み取り範囲）ごとに設定項目が縦に並びます。ROIの数が増えるとページが非常に長くなり、全体を把握しにくく、操作性が低下します。

-   **推奨される解決策:**
    各ROIの設定エリアを `st.expander` で囲み、デフォルトで折りたたまれた状態にすることを提案します。ユーザーは編集したいROIだけを展開して設定できるようになり、UIがすっきりと見やすくなります。

### C-2. OCR実行画面のUI改善

-   **現状の問題:**
    テンプレートの自動検出に失敗した画像が多数ある場合、その画像の数だけ個別にテンプレートを選択するためのプルダウンメニューが表示されます。これによりUIが煩雑になり、ユーザーは同じ操作を何度も繰り返す必要があります。

-   **推奨される解決策:**
    検出に失敗した画像をリスト表示し、複数の画像を選択して一度に同じテンプレートを適用できるようなUIを検討してください。または、画像名とテンプレート選択プルダウンを表形式でコンパクトに表示するだけでも、操作性が向上します。
