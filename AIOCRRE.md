# **AI-OCRリファクタリング計画書：AIエージェント向け開発指示**

**To: AI Development Agent**

このドキュメントは、既存のAI-OCRプロジェクトを、手書き帳票のデータ入力を支援・自動化する、高度なAIエージェントシステムへとリファクタリングするための開発指示書です。各フェーズの指示に従い、開発を遂行してください。

### **🎯 プロジェクト目標**

キーパンチャー（データ入力者）の業務負荷を劇的に削減するため、以下の機能を備えた直感的AI-OCRツールを開発する。

1. **直感的な操作**: 専門知識不要で、マウス操作のみで読み取り設定が完了する。  
2. **高精度な読み取り**: 異なる特性を持つLLMのダブルチェックと、プロンプトベースのルール適用により、手書き文字の認識精度を最大化する。  
3. **継続的な改善**: 人間による修正をシステムが学習し、使えば使うほど賢くなる「ヒューマンインザループ」を実現する。  
4. **高い拡張性**: 新しい帳票やルールに容易に対応できる、柔軟なアーキテクチャを構築する。

### **🏛️ システムアーキテクチャ設計**

**中心概念**: **「帳票テンプレート」** をシステムの核とし、それに関連するすべての情報（ROI、ルール、補正データ）を一元管理する。

**データフロー:**

graph TD  
    subgraph "事前設定フェーズ"  
        A\[Template Editor UI\] \-- 1\. マウスでROIとルールを設定 \--\> B(templates/template\_A.json);  
    end

    subgraph "日常業務フェーズ"  
        C\[Main OCR UI\] \-- 2\. 帳票画像とテンプレートを選択 \--\> D\[OCR Agent\];  
        B \-- 3\. テンプレート情報を読み込み \--\> D;  
        D \-- 4\. ダブルチェックとルール検証 \--\> E\[SQLite Database\];  
        E \-- 5\. 処理結果を読み込み \--\> F\[Review UI\];  
        F \-- 6\. 人間が結果を修正・確定 \--\> E;  
        F \-- 7\. 修正内容をテンプレートにフィードバック \--\> B;  
    end

**技術スタック:**

* **フロントエンド**: Streamlit  
* **画像処理/座標補正**: OpenCV-Python  
* **OCRエンジン**: OpenAI API (gpt-4.1-mini, gpt-4.1-nano)  
* **UIコンポーネント**: streamlit-drawable-canvas-fix
* **データ永続化**:  
  * **テンプレート**: JSONファイル (templates/ディレクトリ)  
  * **処理結果**: SQLite (database/ocr\_results.db)

### **🛠️ 開発フェーズ計画**

#### **フェーズ1: 基盤構築とデータ管理層の実装 (所要: 2日)**

**目標**: システムの根幹となるデータ構造と、それを操作するための管理クラスを実装する。

**主要タスク:**

1. **プロジェクト構造の再設計**:  
   * src/core/: コアロジック（ocr\_agent.py, template\_manager.py, db\_manager.py）  
   * src/app/: Streamlitページ（0\_Template\_Editor.py, 1\_Main\_OCR.py）  
   * templates/: 帳票テンプレートJSONファイルを保存  
   * database/: SQLiteデータベースファイルを保存  
   * uploads/: 一時的な画像ファイルを保存  
2. **データベーススキーマの設計 (db\_manager.py)**:  
   * SQLiteを使用し、以下のテーブルを設計する。  
   * ocr\_jobs: バッチ処理の単位（job\_id, template\_name, created\_at）  
   * ocr\_results: 各画像の各ROIの処理結果（result\_id, job\_id, image\_name, roi\_name, text\_mini, text\_nano, final\_text, confidence\_score, status, corrected\_by\_user）  
3. **テンプレート管理クラスの実装 (template\_manager.py)**:  
   * JSON形式のテンプレートファイルを読み書きするクラスを作成する。  
   * テンプレートのJSON構造を定義する（ROI座標、プロンプトルール、補正辞書など）。

#### **フェーズ2: 直感的なテンプレートエディタの開発 (所要: 3日)**

**目標**: ユーザーがマウス操作だけで帳票の読み取り設定を完了できるUIを構築する。

**主要タスク:**

1. **Streamlitページの作成 (0\_Template\_Editor.py)**:  
   * テンプレートの新規作成または既存テンプレートの選択機能。  
2. **ROI設定機能の実装**:  
   * streamlit-drawable-canvas-fixを導入し、基準画像上に四角形を描画できるようにする。
   * 描画した各四角形（ROI）に、名前（例: 請求書番号）を付けられるようにする。  
3. **プロンプトルール設定機能の実装**:  
   * 各ROIに対し、自然言語で検証ルール（プロンプト）を入力できるテキストエリアを設ける。  
   * **例**: 6桁の半角数字のみを抽出してください。特に「O（オー）」と「0（ゼロ）」の誤読に注意してください。  
4. **テンプレートの保存**:  
   * 「保存」ボタンが押されたら、template\_managerを呼び出し、ROI座標とプロンプトルールをJSONファイルに保存する。

#### **フェーズ3: コアOCRエージェントの実装 (所要: 4日)**

**目標**: 画像から高精度にテキストを抽出し、信頼度を判定するバックエンドロジックを完成させる。

**主要タスク:**

1. **OCRエージェントクラスの作成 (ocr\_agent.py)**:  
   * 一連のOCR処理をカプセル化するクラスを実装する。  
2. **物理的な位置ずれ補正機能の実装**:  
   * **OpenCV**の**特徴点マッチング**（例: ORBアルゴリズム）を使用する。  
   * テンプレート画像と入力画像の間の特徴点を検出し、アフィン変換行列を計算してROI座標を正確に補正する。これが最も高速かつ堅牢な方法である。  
3. **ダブルチェックOCR機能の実装**:  
   * 補正後のROI画像を切り出し、以下の2つのモデルでOCRを実行する。  
     1. gpt-4.1-mini: メインの高精度OCR  
     2. gpt-4.1-nano: 検証用の高速OCR  
4. **信頼度判定ロジックの実装**:  
   * 2つのOCR結果と、テンプレートに定義されたプロンプトルールを基に信頼度を判定する。  
     * **高**: miniとnanoの結果が一致。  
     * **中**: 結果は不一致だが、miniの結果がプロンプトルールに適合する。  
     * **低**: 上記以外。  
5. **結果の永続化**:  
   * すべての処理結果（両モデルのテキスト、信頼度、ステータス）をdb\_manager経由でSQLiteに保存する。

#### **フェーズ4: メインOCR実行・レビュー画面の統合 (所要: 3日)**

**目標**: 日常業務で利用するメイン画面と、人間による確認・修正フローを完成させる。

**主要タスク:**

1. **メイン画面の作成 (1\_Main\_OCR.py)**:  
   * テンプレートを選択し、複数の帳票画像をアップロードできるUIを実装する。  
   * アップロードされた画像はバックグラウンドでOcrAgentに渡され、処理が実行される。  
2. **レビューUIの実装**:  
   * st.data\_editorコンポーネントを活用する。  
   * DBから処理結果を読み込み、表形式で表示する。  
   * **表示項目**: 切り出し画像、最終テキスト（編集可能）、信頼度スコア（色分けバッジ）、ステータス。  
3. **ヒューマンインザループの実装**:  
   * 信頼度が「中」「低」の項目は、ユーザーがテキストを直接編集できるようにする。  
   * ユーザーによる修正が完了し、「確定」ボタンが押されたら、DBのステータスを更新する。  
   * **（高度機能）**: 修正された内容は、将来の精度向上のため、元のテンプレートJSON内の「補正辞書」にフィードバックとして記録する。

#### **フェーズ5: 大量処理対応とパフォーマンス最適化 (所要: 2日)**

**目標**: 大量のファイルを効率的に処理し、システム全体のパフォーマンスを向上させる。

**主要タスク:**

1. **非同期処理の導入**:  
   * OpenAI APIへのリクエスト部分を非同期化（asyncio, aiohttp）し、複数ROIの処理を並列化する。  
2. **キャッシュ戦略**:  
   * Streamlitのキャッシュ機能（@st.cache\_data, @st.cache\_resource）を適切に利用し、テンプレートの読み込みやDB接続のオーバーヘッドを削減する。  
3. **バッチ処理機能**:  
   * 単一ファイルだけでなく、フォルダごとドラッグ＆ドロップして一括で処理を開始できるUIを追加する。  
   * 処理の進捗状況をプログレスバーで表示する。

この計画書に基づき、各フェーズを着実に実行することで、キーパンチャーの業務を革新する、直感的でパワフルなAI-OCRエージェントが完成します。直ちに行動を開始してください。